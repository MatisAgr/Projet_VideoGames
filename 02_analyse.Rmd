---
title: "Analyse des Jeux Vidéo Steam"
author: "IPSSI"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ggplot2)
library(caret)
```

## Chargement des données

```{r load}
df <- readRDS("games_cleaned.rds")
str(df)
```

## Nettoyage effectué

Fichier original : suppression des doublons, valeurs manquantes dans les colonnes critiques (Price, Metacritic.score), filtrage des jeux sans Peak.CCU, sélection des colonnes pertinentes, extraction de l'année, calcul du ratio avis positifs/négatifs.

## Analyse descriptive

```{r describe}
summary(df)

cat("\nValeurs manquantes :\n")
print(colSums(is.na(df)))
```

## Visualisations

### Prix et Metacritic

```{r plot1}
ggplot(df, aes(x = Price, y = Metacritic.score)) +
  geom_point(alpha = 0.4, color = "steelblue") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(title = "Relation Prix vs Score Metacritic",
       x = "Prix (€)", y = "Score Metacritic") +
  theme_minimal()
```

### Distribution des prix

```{r plot2}
ggplot(df, aes(x = Price)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "black") +
  scale_x_log10() +
  labs(title = "Distribution des Prix (échelle log)",
       x = "Prix (€)", y = "Nombre de jeux") +
  theme_minimal()
```

### Peak CCU par année

```{r plot3}
df %>%
  group_by(Year) %>%
  summarise(Avg_CCU = mean(Peak.CCU, na.rm = TRUE)) %>%
  ggplot(aes(x = Year, y = Avg_CCU)) +
  geom_line(color = "darkblue", size = 1) +
  geom_point(size = 2) +
  labs(title = "Peak CCU Moyen par Année",
       x = "Année", y = "Peak CCU") +
  theme_minimal()
```

### Top 10 genres par nombre de jeux

```{r plot4}
df %>%
  separate_rows(Genres, sep = ",") %>%
  mutate(Genres = trimws(Genres)) %>%
  group_by(Genres) %>%
  summarise(Count = n()) %>%
  arrange(desc(Count)) %>%
  head(10) %>%
  ggplot(aes(x = reorder(Genres, Count), y = Count)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "Top 10 des Genres",
       x = "Genre", y = "Nombre de jeux") +
  theme_minimal()
```

### Score utilisateur vs Peak CCU

```{r plot5}
ggplot(df, aes(x = User.score, y = log10(Peak.CCU + 1))) +
  geom_point(alpha = 0.4, color = "darkgreen") +
  geom_smooth(method = "lm", se = TRUE, color = "red") +
  labs(title = "Score Utilisateur vs Peak CCU (log)",
       x = "Score Utilisateur", y = "Log10(Peak CCU)") +
  theme_minimal()
```

### Ratio avis positifs/négatifs

```{r plot6}
ggplot(df, aes(x = Review.Ratio)) +
  geom_histogram(bins = 40, fill = "purple", alpha = 0.7, color = "black") +
  labs(title = "Distribution du Ratio Avis Positifs",
       x = "Ratio Positifs/(Positifs+Négatifs)", y = "Fréquence") +
  theme_minimal()
```

## Modélisation

Prédiction du Peak CCU à partir du Price, Metacritic.score, User.score et Review.Ratio.

```{r model}
set.seed(123)

df_model <- df %>%
  drop_na(Price, Metacritic.score, User.score, Review.Ratio, Peak.CCU) %>%
  mutate(Log_Peak_CCU = log10(Peak.CCU + 1))

idx <- createDataPartition(df_model$Log_Peak_CCU, p = 0.8, list = FALSE)
train <- df_model[idx, ]
test <- df_model[-idx, ]

model <- lm(Log_Peak_CCU ~ Price + Metacritic.score + User.score + Review.Ratio, 
            data = train)

summary(model)

pred <- predict(model, test)
rmse <- sqrt(mean((test$Log_Peak_CCU - pred)^2))
cat("\nRMSE du modèle :", round(rmse, 4), "\n")

saveRDS(model, "model_peak_ccu.rds")
```

## Prédictions sur données de test

```{r pred_table}
results <- data.frame(
  Actual = test$Peak.CCU,
  Predicted = 10^pred - 1,
  Error = abs(test$Peak.CCU - (10^pred - 1))
)

head(results, 10)
```
